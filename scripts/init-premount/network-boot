CMDLINE="$(cat /proc/cmdline)"
for x in $CMDLINE; do
  case $x in
    server=*)
      SERVER="${x//server=}"
      ;;
  esac
done

if [ -z "$SERVER" ]; then
	clear
	echo server not set in kernel cmdline, aborting boot process
	sleep 5
	exit
fi

. /scripts/functions
configure_networking
clear
ip a
echo Using server $SERVER
sleep 5
while [[ $(netstat -t | grep 22 | wc -l) -gt 0 ]]; do
	if [[ $(cat /network-boot/cancel_boot) -eq 1 ]]; then
		exit
	fi
	echo Found active SSH session, not booting for 30 seconds...
	echo To stop the machine from booting completely, do \"echo 1 \> /network-boot/cancel_boot\"
	sleep 30
done
wget -q -O /network-boot/config.sh $SERVER/config.sh
chmod +x /network-boot/config.sh
/network-boot/config.sh
